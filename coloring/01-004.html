<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Sea ToDo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(160deg, #020c1b 0%, #0a192f 50%, #112240 100%);
            color: #e6f1ff;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0a192f;
        }
        ::-webkit-scrollbar-thumb {
            background: #233554;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #304a75;
        }

        /* グラスモーフィズム効果 */
        .glass-panel {
            background: rgba(17, 34, 64, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(230, 241, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* チェックボックスのアニメーション */
        .custom-checkbox {
            appearance: none;
            background-color: transparent;
            border: 2px solid #64ffda;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #0a192f;
            background-color: #0a192f;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked {
            background-color: #64ffda;
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        /* タスクアイテムのホバー効果 */
        .task-item {
            transition: transform 0.2s, background-color 0.2s;
        }
        .task-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* 完了したタスクのスタイル */
        .task-completed .task-text {
            text-decoration: line-through;
            color: #8892b0;
        }

        /* トースト通知のアニメーション */
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4 selection:bg-teal-300 selection:text-slate-900">

    <!-- メインコンテナ -->
    <main class="w-full max-w-2xl glass-panel rounded-2xl p-6 md:p-8 relative overflow-hidden min-h-[80vh] flex flex-col">
        
        <!-- 装飾的な背景光 -->
        <div class="absolute top-[-50px] left-[-50px] w-32 h-32 bg-blue-500 rounded-full mix-blend-screen filter blur-[60px] opacity-20 pointer-events-none"></div>
        <div class="absolute bottom-[-50px] right-[-50px] w-32 h-32 bg-teal-400 rounded-full mix-blend-screen filter blur-[60px] opacity-20 pointer-events-none"></div>

        <!-- ヘッダー -->
        <header class="mb-8 text-center relative z-10">
            <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-slate-100 mb-2">Deep Focus ToDo</h1>
            <p class="text-slate-400 text-sm">深海の中で、やるべきことに集中する。</p>
        </header>

        <!-- コントロールエリア -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 relative z-10">
            <!-- フィルターボタン -->
            <div class="flex bg-[#0a192f] p-1 rounded-lg border border-slate-700/50">
                <button id="filter-all" onclick="setFilter('all')" class="px-4 py-1.5 rounded-md text-sm transition-colors bg-[#112240] text-teal-300 shadow-sm">すべて</button>
                <button id="filter-active" onclick="setFilter('active')" class="px-4 py-1.5 rounded-md text-sm transition-colors text-slate-400 hover:text-slate-200">未完了のみ</button>
            </div>
            
            <!-- 新規追加ボタン -->
            <button onclick="openModal()" class="w-full md:w-auto bg-teal-500 hover:bg-teal-400 text-[#0a192f] font-bold py-2 px-6 rounded-lg transition-all shadow-lg shadow-teal-500/20 flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> 新規タスク
            </button>
        </div>

        <!-- タスクリスト -->
        <div class="flex-grow relative z-10">
            <ul id="todo-list" class="space-y-3">
                <!-- タスクはJSでここに描画されます -->
            </ul>
            <div id="empty-state" class="hidden text-center py-12 text-slate-500">
                <i class="fas fa-water text-4xl mb-3 opacity-50"></i>
                <p>タスクはありません。静かな海です。</p>
            </div>
        </div>

    </main>

    <!-- モーダル (追加・編集用) -->
    <div id="modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="glass-panel w-full max-w-md rounded-xl p-6 transform scale-100 transition-transform duration-300 border border-slate-700">
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-teal-300">タスクの追加</h2>
            <form id="task-form" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="task-id">
                <div class="mb-4">
                    <label for="task-input" class="block text-sm font-medium text-slate-400 mb-2">内容</label>
                    <input type="text" id="task-input" required 
                        class="w-full bg-[#0a192f] border border-slate-600 rounded-lg py-3 px-4 text-slate-100 focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition-colors"
                        placeholder="例: 深海探査レポートを作成する">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg text-slate-300 hover:bg-slate-700/50 transition-colors">キャンセル</button>
                    <button type="submit" class="px-6 py-2 bg-teal-500 hover:bg-teal-400 text-[#0a192f] font-bold rounded-lg shadow-lg shadow-teal-500/20 transition-all">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- エラートースト通知 -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-red-500/90 text-white px-6 py-3 rounded-lg shadow-xl hidden items-center gap-3 backdrop-blur-md z-50 max-w-[90vw]">
        <i class="fas fa-exclamation-circle"></i>
        <span id="toast-message">エラーが発生しました</span>
    </div>

    <script>
        // --- 初期設定とデータ ---
        
        const dummyData = [
            { id: '1', text: '深海探査船の点検を行う', completed: false, createdAt: Date.now() },
            { id: '2', text: '海洋生物データのバックアップ', completed: true, createdAt: Date.now() - 10000 },
            { id: '3', text: '酸素供給システムのフィルター交換', completed: false, createdAt: Date.now() - 20000 },
            { id: '4', text: '次回の潜航ルートを計画する', completed: false, createdAt: Date.now() - 30000 },
            { id: '5', text: '研究チームとの定例ミーティング', completed: true, createdAt: Date.now() - 40000 },
        ];

        let tasks = [];
        let currentFilter = 'all';

        // --- DOM要素 ---
        const listElement = document.getElementById('todo-list');
        const emptyStateElement = document.getElementById('empty-state');
        const modal = document.getElementById('modal');
        const taskForm = document.getElementById('task-form');
        const taskInput = document.getElementById('task-input');
        const taskIdInput = document.getElementById('task-id');
        const modalTitle = document.getElementById('modal-title');
        const filterAllBtn = document.getElementById('filter-all');
        const filterActiveBtn = document.getElementById('filter-active');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // --- 初期化 ---
        function init() {
            try {
                const storedTasks = localStorage.getItem('deepsea-todo-tasks');
                if (storedTasks) {
                    tasks = JSON.parse(storedTasks);
                } else {
                    tasks = [...dummyData];
                    saveTasks();
                }
                renderTasks();
            } catch (error) {
                showError('データの読み込みに失敗しました。');
                console.error(error);
            }
        }

        // --- コア機能 ---

        function renderTasks() {
            listElement.innerHTML = '';
            
            // フィルタリング
            const filteredTasks = tasks.filter(task => {
                if (currentFilter === 'active') return !task.completed;
                return true;
            });

            // ソート (未完了を上に、その中で作成順)
            filteredTasks.sort((a, b) => {
                if (a.completed === b.completed) return b.createdAt - a.createdAt;
                return a.completed ? 1 : -1;
            });

            if (filteredTasks.length === 0) {
                emptyStateElement.classList.remove('hidden');
            } else {
                emptyStateElement.classList.add('hidden');
                filteredTasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = `task-item bg-[#112240] rounded-xl p-4 flex items-center justify-between gap-4 border border-slate-700/50 group ${task.completed ? 'task-completed opacity-60' : ''}`;
                    
                    li.innerHTML = `
                        <div class="flex items-center gap-4 flex-grow min-w-0 cursor-pointer" onclick="openEditModal('${task.id}')">
                            <div class="relative flex items-center" onclick="event.stopPropagation()">
                                <input type="checkbox" class="custom-checkbox" 
                                    ${task.completed ? 'checked' : ''} 
                                    onchange="toggleTask('${task.id}')">
                            </div>
                            <span class="task-text text-slate-200 truncate select-none text-base md:text-lg">${escapeHtml(task.text)}</span>
                        </div>
                        <button onclick="deleteTask('${task.id}')" class="text-slate-500 hover:text-red-400 transition-colors p-2 rounded-lg hover:bg-slate-700/30" aria-label="削除">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    listElement.appendChild(li);
                });
            }
        }

        function saveTasks() {
            try {
                localStorage.setItem('deepsea-todo-tasks', JSON.stringify(tasks));
            } catch (error) {
                showError('データの保存に失敗しました。');
            }
        }

        function addTask(text) {
            try {
                const newTask = {
                    id: Date.now().toString(),
                    text: text,
                    completed: false,
                    createdAt: Date.now()
                };
                tasks.unshift(newTask); // 配列の先頭に追加
                saveTasks();
                renderTasks();
            } catch (e) {
                showError('タスクの追加中にエラーが発生しました。');
            }
        }

        function updateTask(id, text) {
            try {
                const taskIndex = tasks.findIndex(t => t.id === id);
                if (taskIndex > -1) {
                    tasks[taskIndex].text = text;
                    saveTasks();
                    renderTasks();
                } else {
                    throw new Error('タスクが見つかりません');
                }
            } catch (e) {
                showError('タスクの更新に失敗しました。');
            }
        }

        function toggleTask(id) {
            try {
                const task = tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    saveTasks();
                    renderTasks();
                }
            } catch (e) {
                showError('ステータスの更新に失敗しました。');
            }
        }

        function deleteTask(id) {
            if(!confirm('このタスクを削除してもよろしいですか？')) return;
            
            try {
                tasks = tasks.filter(t => t.id !== id);
                saveTasks();
                renderTasks();
            } catch (e) {
                showError('削除に失敗しました。');
            }
        }

        // --- UI操作 ---

        function openModal() {
            modalTitle.innerText = '新規タスクの作成';
            taskIdInput.value = '';
            taskInput.value = '';
            modal.classList.remove('hidden');
            setTimeout(() => taskInput.focus(), 100);
        }

        function openEditModal(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                modalTitle.innerText = 'タスクの編集';
                taskIdInput.value = task.id;
                taskInput.value = task.text;
                modal.classList.remove('hidden');
                setTimeout(() => taskInput.focus(), 100);
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const text = taskInput.value.trim();
            const id = taskIdInput.value;

            if (!text) return;

            if (id) {
                updateTask(id, text);
            } else {
                addTask(text);
            }
            closeModal();
        }

        function setFilter(type) {
            currentFilter = type;
            
            // ボタンのスタイル切り替え
            if (type === 'all') {
                filterAllBtn.className = "px-4 py-1.5 rounded-md text-sm transition-colors bg-[#112240] text-teal-300 shadow-sm";
                filterActiveBtn.className = "px-4 py-1.5 rounded-md text-sm transition-colors text-slate-400 hover:text-slate-200";
            } else {
                filterAllBtn.className = "px-4 py-1.5 rounded-md text-sm transition-colors text-slate-400 hover:text-slate-200";
                filterActiveBtn.className = "px-4 py-1.5 rounded-md text-sm transition-colors bg-[#112240] text-teal-300 shadow-sm";
            }
            renderTasks();
        }

        function showError(msg) {
            toastMessage.innerText = msg;
            toast.classList.remove('hidden');
            toast.classList.add('toast-enter', 'flex');
            
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('flex');
            }, 4000);
        }

        // モーダルの外側クリックで閉じる
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // HTMLエスケープ処理 (XSS対策)
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }

        // アプリ起動
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>